
# Quality Metrics Tools

This is a public code repository of the [Translational Bioimaging Resource–MRI](http://astrolabe.arizona.edu/) core group at the [University of Arizona](https://research.arizona.edu/facilities/core-facilities/translational-bioimaging-resource-mri).

**Authors**: [Tom Hicks](https://github.com/hickst) and [Dianne Patterson](https://github.com/dkp)

**About**: This project provides several programs to visualize, compare, and review the image quality metrics (IQMs) produced by the [MRIQC program](https://github.com/poldracklab/mriqc). MRIQC extracts no-reference IQMs from structural (T1w and T2w) and functional MRI (magnetic resonance imaging) data.

## Using QMTools via Docker

The easiest way to use the QMTools is via the publicly available [Docker container](https://hub.docker.com/repository/docker/hickst/qmtools). With this approach, the QMTools, located in the Docker container, are called by auxiliary run-time scripts to process data from input and output directories which are made available (bind-mounted) to the container. Setup and run-time support scripts which simplify this process are available in the [QMTools Support project on GitHub](https://github.com/hickst/qmtools-setup). Since this approach requires only **Docker** and the **bash shell** to be installed on your local computer, it has a minimal "footprint". To use the QMTools via Docker:

### 1. Checkout the support project (ONCE)

Git `clone` this project somewhere within your "home" area and enter the project directory. For example:
```
  > cd /Users/johndoe/qmtools
  > git clone https://github.com/hickst/qmtools-support.git qmtools
  > cd qmtools
  > pwd
  /Users/johndoe/qmtools
```

***Note**: hereafter, this directory will be called the "project directory".*


### 2. Run the Setup Script (ONCE)

The QMTools Docker container requires several directories to be created in the project directory and subsequently made available to the container. The setup script creates the necessary directories and the run scripts make them available to the container. Run the Setup script (once) within the project directory to create the necessary directories:
```
 > bash setup.sh
```

When the script finishes, you should see that three new, empty directories: **inputs**, **reports**, and **fetched** have been created in the current (projects) directory.

The **inputs** directory will be used to hold, at least, one of your group data files: i.e., a `.tsv` file output from a prior run of the __MRIQC__ program.

The **fetched** directory will be used to hold IQM (Image Quality Metrics) data retrieved from an online database of previously collected quality metrics that is maintained by the MRIQC group. For more information, see the documentation for the [QMFetcher program](https://github.com/hickst/qmtools/blob/master/docs/QMFetcher.md).

The **reports** directory will be used to hold visualizations and reports generated by one of the QMTools. Repeated runs of the QMTools programs will generate different sub-directories within the main **reports** directory.

### 3. Run a QMTool through a Run Script

Having completed the setup phase, you are now ready to run one or more of the QMTools.

In general, you will utilize the QMTools by copying IMQ data files (i.e., MRIQC group files) into the **inputs** directory and/or by fetching IMQ data from the MRIQC database server into the **fetched** directory. Reports produced by the QMTools will be output into a sub-directory of the **reports** directory.

**Please see the individual tools documentation for instructions on running each tool.**

[QMTraffic]() - Normalizes a set of MRIQC image quality metrics and creates a tabular HTML report visualizing how much each image's metrics deviate from the norm.

[QMFetcher]() - Queries the MRIQC database server to fetch image quality metrics for images previously processed by neuroimaging groups all over the world. A query may specify multiple image metadata parameters to filter the images whose metrics are returned. As query parameters are read from user-created files, queries may be easily and consistently repeated.

[QMViolin]() - Compares two sets of MRIQC image quality metrics and creates an HTML report visualizing how the groups compare for each IQM. The two data sets to be compared can both be user-generated OR both fetched from the MRIQC database OR one of each.

## Relevant Links

This project was inspired by a 2019 Neurohackademy project available [here](https://github.com/elizabethbeard/mriqception).

The [Swagger UI for the MRIQC web API](https://mriqc.nimh.nih.gov). Scroll down to the `Models` section, which documents the database schema (structure and field names) that can be queried with **QMFetcher**.

The source code for the [MRIQC web API](https://mriqc.nimh.nih.gov/), which provides the API that **QMFetcher** uses to query the MRIQC database.

[Discussions and Jupyter notebooks](https://www.kaggle.com/chrisfilo/mriqc/code) which utilize the same MRIQC web API that this project uses.

## Installing with Conda

You can also install the main QMTools project (*not the Support project*) locally on your computer and run the tools from there. Using [Miniconda](https://docs.conda.io/en/latest/miniconda.html), you can easily set up an isolated environment to run the QMTools without interfering with other local software.

## Installing with a Python Virtual Environment

More knowledgable users can install the main QMTools project (*not the Support project*) locally using a Python virtual environment.

## Relevant References

- Esteban O, Blair RW, Nielson DM, Varada JC, Marrett S, Thomas AG et al. (2019). Crowdsourced MRI quality metrics and expert quality annotations for training of humans and machines. Sci Data 6: 30.

## License

This software is licensed under Apache License Version 2.0.

Copyright (c) The University of Arizona, 2021. All rights reserved.
